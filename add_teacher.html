<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Add Staff - BIS</title>

<link rel="stylesheet"
href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<style>
:root {
--chocolate:#3E2723;
--cream:#FFF8E1;
--gold:#FFB300;
--white:#ffffff;
}

*{
margin:0;
padding:0;
box-sizing:border-box;
font-family:'Segoe UI',sans-serif;
}

body{
background-color:#fcfaf5;
padding:20px;
}

.header{
display:flex;
align-items:center;
gap:15px;
margin-bottom:25px;
color:var(--chocolate);
}

.back-btn{
font-size:24px;
color:var(--chocolate);
text-decoration:none;
}

.form-card{
background:var(--white);
padding:25px;
border-radius:15px;
box-shadow:0 4px 15px rgba(0,0,0,0.05);
max-width:650px;
margin:auto;
}

.photo-section{
display:flex;
flex-direction:column;
align-items:center;
margin-bottom:20px;
}

.photo-preview{
width:110px;
height:110px;
border-radius:15px;
background:#eee;
border:2px dashed var(--chocolate);
display:flex;
align-items:center;
justify-content:center;
overflow:hidden;
margin-bottom:10px;
}

.photo-preview img{
width:100%;
height:100%;
object-fit:cover;
}

.upload-label{
font-size:12px;
color:var(--chocolate);
cursor:pointer;
text-decoration:underline;
font-weight:600;
}

.section-title{
font-size:13px;
color:var(--gold);
text-transform:uppercase;
letter-spacing:1px;
margin:25px 0 10px 0;
border-bottom:1px solid #eee;
padding-bottom:5px;
}

.input-group{
margin-bottom:15px;
position:relative;
}

.input-group label{
display:block;
margin-bottom:5px;
font-weight:600;
color:var(--chocolate);
font-size:13px;
}

input,select{
width:100%;
padding:12px;
border:1.5px solid #d7ccc8;
border-radius:10px;
font-size:15px;
outline:none;
}

.row{
display:flex;
gap:10px;
}

.row .input-group{
flex:1;
}

.subject-container{
border:1.5px solid #d7ccc8;
border-radius:10px;
padding:10px;
max-height:200px;
overflow-y:auto;
display:grid;
grid-template-columns:1fr 1fr;
gap:8px;
}

.sub-item{
display:flex;
align-items:center;
gap:8px;
font-size:13px;
color:var(--chocolate);
}

.toggle-pass{
position:absolute;
right:15px;
top:38px;
color:#888;
cursor:pointer;
}

.submit-btn{
width:100%;
padding:15px;
background:var(--chocolate);
color:white;
border:none;
border-radius:10px;
font-size:16px;
font-weight:bold;
margin-top:25px;
cursor:pointer;
}
</style>
</head>

<body>

<div class="header">
<a href="principal_dash.html" class="back-btn">
<i class="fas fa-arrow-left"></i>
</a>
<h2>Staff Recruitment</h2>
</div>

<div class="form-card">
<form id="addStaffForm">

<div class="photo-section">
<div class="photo-preview" id="imageDisplay">
<i class="fas fa-user-tie" style="font-size:40px;color:#ccc;"></i>
</div>

<label for="staffPhoto" class="upload-label">
Upload Staff Portrait
</label>

<input type="file" id="staffPhoto" accept="image/*" style="display:none;">
</div>

<p class="section-title">Account Security</p>

<div class="row">
<div class="input-group">
<label>Staff ID</label>
<input type="text" id="staffID" readonly>
</div>

<div class="input-group">
<label>Password</label>
<input type="password" id="staffPassword" required>
<i class="fas fa-eye toggle-pass" onclick="togglePassword()"></i>
</div>
</div>

<p class="section-title">Employment Details</p>

<div class="row">
<div class="input-group">
<label>Job Designation</label>
<select id="staffRoleSelect" onchange="toggleSubjectArea()">
<option value="Teacher">Subject Teacher</option>
<option value="Form Teacher">Form Teacher</option>
<option value="Admin">Administrator</option>
<option value="Bursar">Bursar</option>
</select>
</div>

<div class="input-group">
<label>Monthly Salary</label>
<input type="number" id="staffSalary" required>
</div>
</div>

<div id="classSection">
<p class="section-title">Class Category</p>

<div class="input-group">
<label>Select Class</label>
<select id="classSelect" onchange="renderSubjects()">
<option value="">Choose Category</option>
<option value="JSS">JSS</option>
<option value="SSS">SSS</option>
</select>
</div>
</div>

<p class="section-title">Personal Information</p>

<div class="input-group">
<label>Full Name</label>
<input type="text" id="staffName" required>
</div>

<div class="row">
<div class="input-group">
<label>Gender</label>
<select id="staffGender" required>
<option value="">Select</option>
<option>Male</option>
<option>Female</option>
</select>
</div>

<div class="input-group">
<label>Phone</label>
<input type="tel" id="staffPhone" required>
</div>
</div>

<div id="subjectSection">
<p class="section-title">Assign Subjects</p>
<div class="subject-container" id="subjectGrid"></div>
</div>

<button class="submit-btn">
Complete Staff Registration
</button>

</form>
</div>


<script type="module">

import { initializeApp }
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";

import {
getFirestore,
collection,
getDocs,
query,
where,
addDoc
}
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

import {
getStorage,
ref,
uploadBytes,
getDownloadURL
}
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";


const firebaseConfig={
apiKey:"AIzaSyBIQog_gsN6U-2JXwpv8CBSMLuP92W6a7Q",
authDomain:"school-management-system-2f7de.firebaseapp.com",
projectId:"school-management-system-2f7de",
storageBucket:"school-management-system-2f7de.appspot.com",
messagingSenderId:"518987437886",
appId:"1:518987437886:web:3d451457c4a6457e007e6f"
};

const app=initializeApp(firebaseConfig);
const db=getFirestore(app);
const storage=getStorage(app);


/* SUBJECT DATA */

const subjectData={

JSS:[
"Mathematics","English","Basic science",
"Basic technology","Creative cultural arts",
"Security","History","French","Hausa",
"Computer","Agricultural science",
"Home economics","Social Studies",
"Civic education"
],

SSS:[
"Mathematics","English","Physics","Chemistry",
"Biology","Literature","CRS/IRS",
"Further mathematics","Commerce",
"Accounting","Computer science",
"Economics","Marketing",
"Civic education"
]

};

const grid=document.getElementById("subjectGrid");


window.renderSubjects=function(){

grid.innerHTML="";

const selectedClass=
document.getElementById("classSelect").value;

if(!selectedClass) return;

subjectData[selectedClass].forEach(sub=>{

grid.innerHTML+=`
<div class="sub-item">
<input type="checkbox" value="${sub}">
<span>${sub}</span>
</div>`;

});

};



// IMAGE PREVIEW
staffPhoto.addEventListener("change",e=>{
const file=e.target.files[0];
if(!file) return;

const reader=new FileReader();

reader.onload=evt=>{
imageDisplay.innerHTML=`<img src="${evt.target.result}">`;
};

reader.readAsDataURL(file);
});


// AUTO STAFF ID
async function generateStaffID(){

const q=query(
collection(db,"users"),
where("role","in",["teacher","admin"])
);

const snap=await getDocs(q);

let max=0;

snap.forEach(doc=>{
const id=doc.data().username;

if(id?.includes("BIS/STF/")){
const num=parseInt(id.split("/")[2]);
if(num>max) max=num;
}
});

staffID.value="BIS/STF/"+String(max+1).padStart(3,"0");
}

generateStaffID();


// PASSWORD TOGGLE
window.togglePassword=()=>{
staffPassword.type=
staffPassword.type==="password"?"text":"password";
};


// SHOW/HIDE SUBJECT AREA
window.toggleSubjectArea=()=>{

const role=staffRoleSelect.value;

const isTeacher=
role==="Teacher"||role==="Form Teacher";

subjectSection.style.display=isTeacher?"block":"none";
classSection.style.display=isTeacher?"block":"none";

};



// SUBMIT
addStaffForm.addEventListener("submit",async e=>{

e.preventDefault();

try{

const roleSelect=staffRoleSelect.value;

const isTeacher=
roleSelect==="Teacher"||
roleSelect==="Form Teacher";

let selectedSubjects=[];

if(isTeacher){

document
.querySelectorAll("#subjectGrid input:checked")
.forEach(cb=>selectedSubjects.push(cb.value));

if(selectedSubjects.length===0){
alert("Assign at least one subject.");
return;
}

}


// upload image
let photoURL="";
const file=staffPhoto.files[0];

if(file){

const storageRef=ref(
storage,
`staffPhotos/${Date.now()}_${file.name}`
);

await uploadBytes(storageRef,file);
photoURL=await getDownloadURL(storageRef);

}


// save
await addDoc(collection(db,"users"),{

fullName:staffName.value,
username:staffID.value,
password:staffPassword.value,
role:isTeacher?"teacher":"admin",
designation:roleSelect,
classCategory:classSelect.value || "",
salary:Number(staffSalary.value),
gender:staffGender.value,
phone:staffPhone.value,
subjects:selectedSubjects,
photo:photoURL,
createdAt:Date.now()

});

alert("âœ… Staff Added Successfully");
location.reload();

}catch(err){
console.error(err);
alert("Error adding staff");
}

});

</script>

</body>
</html>
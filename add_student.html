<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Add Student - BIS</title>

<link rel="stylesheet"
href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<style>

:root{
--chocolate:#3E2723;
--gold:#FFB300;
}

*{
margin:0;
padding:0;
box-sizing:border-box;
font-family:'Segoe UI',sans-serif;
}

body{
background:#fcfaf5;
padding:20px;
}

.header{
color:var(--chocolate);
margin-bottom:20px;
}

.form-card{
background:white;
padding:25px;
border-radius:15px;
box-shadow:0 4px 15px rgba(0,0,0,0.05);
max-width:600px;
margin:auto;
}

.input-group{
margin-bottom:15px;
}

.input-group label{
display:block;
margin-bottom:5px;
font-weight:600;
color:var(--chocolate);
font-size:13px;
}

input,select,textarea{
width:100%;
padding:12px;
border:1.5px solid #d7ccc8;
border-radius:10px;
font-size:15px;
}

.row{
display:flex;
gap:10px;
}

.row .input-group{
flex:1;
}

.submit-btn{
width:100%;
padding:15px;
background:var(--chocolate);
color:white;
border:none;
border-radius:10px;
font-size:16px;
font-weight:bold;
margin-top:20px;
cursor:pointer;
}

.submit-btn:disabled{
opacity:.6;
cursor:not-allowed;
}

.photo-preview{
width:100px;
height:100px;
border-radius:50%;
background:#eee;
border:2px dashed var(--chocolate);
display:flex;
align-items:center;
justify-content:center;
overflow:hidden;
margin:0 auto 10px;
}

.photo-preview img{
width:100%;
height:100%;
object-fit:cover;
}

.upload-label{
display:block;
text-align:center;
font-size:12px;
color:var(--chocolate);
cursor:pointer;
text-decoration:underline;
margin-bottom:20px;
}

</style>
</head>

<body>

<h2 class="header">Student Registration</h2>

<div class="form-card">

<form id="addStudentForm">

<div class="photo-preview" id="imageDisplay">
<i class="fas fa-camera" style="font-size:30px;color:#ccc;"></i>
</div>

<label for="stuPhoto" class="upload-label">Upload Passport</label>
<input type="file" id="stuPhoto" hidden accept="image/*">


<div class="row">
<div class="input-group">
<label>Student ID</label>
<input type="text" id="stuID" readonly>
</div>

<div class="input-group">
<label>Class</label>
<select id="stuClass" required>
<option value="">Select</option>
<option>JSS1</option>
<option>JSS2</option>
<option>JSS3</option>
<option>SS1</option>
<option>SS2</option>
<option>SS3</option>
</select>
</div>
</div>

<div class="input-group">
<label>Full Name</label>
<input type="text" id="stuName" required>
</div>

<div class="row">
<div class="input-group">
<label>Password</label>
<input type="password" id="stuPass" required>
</div>

<div class="input-group">
<label>Gender</label>
<select id="stuGender" required>
<option value="">Select</option>
<option>Male</option>
<option>Female</option>
</select>
</div>
</div>

<div class="input-group">
<label>Date of Birth</label>
<input type="date" id="stuDOB" required>
</div>

<div class="input-group">
<label>Parent Name</label>
<input type="text" id="parentName" required>
</div>

<div class="input-group">
<label>Phone</label>
<input type="tel" id="parentPhone" required>
</div>

<div class="input-group">
<label>Address</label>
<textarea id="stuAddress"></textarea>
</div>

<button class="submit-btn">Complete Registration</button>

</form>
</div>

<script type="module">

import { initializeApp } from
"https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";

import {
getFirestore,
doc,
setDoc,
getDoc,
serverTimestamp
} from
"https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

import {
getStorage,
ref,
uploadBytes,
getDownloadURL
} from
"https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";


/* ✅ YOUR REAL CONFIG (FIXED STORAGE BUCKET) */
const firebaseConfig = {

apiKey: "AIzaSyBIQog_gsN6U-2JXwpv8CBSMLuP92W6a7Q",
authDomain: "school-management-system-2f7de.firebaseapp.com",
projectId: "school-management-system-2f7de",
storageBucket: "school-management-system-2f7de.appspot.com",
messagingSenderId: "518987437886",
appId: "1:518987437886:web:3d451457c4a6457e007e6f"

};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const storage = getStorage(app);


/* Generate FAST ID */
function generateID(){
stuID.value =
"BIS-" + crypto.randomUUID().slice(0,6).toUpperCase();
}
generateID();


let selectedFile=null;

stuPhoto.addEventListener("change", e=>{

selectedFile = e.target.files[0];

if(selectedFile){
imageDisplay.innerHTML =
`<img src="${URL.createObjectURL(selectedFile)}">`;
}

});


addStudentForm.addEventListener("submit", async e=>{

e.preventDefault();

const btn=document.querySelector(".submit-btn");
btn.disabled=true;
btn.innerText="Registering...";

try{

const username = stuID.value;

/* duplicate check */
const userRef = doc(db,"users",username);
const existingUser = await getDoc(userRef);

if(existingUser.exists()){
alert("Student already exists!");
btn.disabled=false;
btn.innerText="Complete Registration";
return;
}


/* Upload photo ONLY if selected */
let photoURL="";

if(selectedFile){

const storageRef =
ref(storage,"student_passports/"+username);

await uploadBytes(storageRef,selectedFile);

photoURL =
await getDownloadURL(storageRef);

}


/* SAVE USER */
await setDoc(userRef,{

username,
password: stuPass.value,
fullName: stuName.value,
class: stuClass.value,
gender: stuGender.value,
dob: stuDOB.value,
parentName: parentName.value,
parentPhone: parentPhone.value,
address: stuAddress.value,
photo: photoURL,
role:"student",
createdAt: serverTimestamp()

});

alert("✅ Student Registered!");

location.href="principal_dash.html";

}catch(err){

console.error(err);
alert(err.message);

btn.disabled=false;
btn.innerText="Complete Registration";

}

});

</script>

</body>
</html>
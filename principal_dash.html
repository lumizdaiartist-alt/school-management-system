<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Principal Dashboard - BIS</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>
/* KEEPING YOUR ORIGINAL DESIGN */
:root {
    --chocolate: #3E2723;
    --cream: #FFF8E1;
    --gold: #FFB300;
}

body{
margin:0;
font-family:'Segoe UI',sans-serif;
background:#fcfaf5;
}

.navbar{
background:var(--chocolate);
color:white;
padding:15px 20px;
display:flex;
justify-content:space-between;
}

.main{
padding:30px;
}

.card{
background:white;
padding:20px;
border-radius:14px;
box-shadow:0 4px 10px rgba(0,0,0,.05);
margin-bottom:20px;
}
</style>
</head>

<body>

<div class="navbar">
<h3>BIS Principal Portal</h3>
<button onclick="logout()" style="background:#d32f2f;border:none;color:white;padding:8px 14px;border-radius:8px;cursor:pointer;">
Logout
</button>
</div>

<div class="main">

<div class="card">
<h2 id="principalName">Loading...</h2>
<p id="principalEmail"></p>
</div>

<div class="card">
<h3>Students: <span id="studentCount">0</span></h3>
<h3>Teachers: <span id="teacherCount">0</span></h3>
</div>

</div>


<script type="module">

/* üî• FIREBASE */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";

import {
getAuth,
onAuthStateChanged,
signOut
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

import {
getFirestore,
doc,
getDoc,
collection,
getDocs
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";


const firebaseConfig = {
apiKey: "YOUR_KEY",
authDomain: "YOUR_DOMAIN",
projectId: "YOUR_ID",
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);



/* üîê FORCE LOGIN */
onAuthStateChanged(auth, async (user) => {

if(!user){
window.location.href = "index.html";
return;
}

try{

// get Firestore profile
const userRef = doc(db,"users",user.uid);
const snap = await getDoc(userRef);

if(!snap.exists()){
alert("No dashboard assigned.");
await signOut(auth);
window.location.href="index.html";
return;
}

const data = snap.data();

if(data.role !== "principal"){
alert("Access denied.");
await signOut(auth);
window.location.href="index.html";
return;
}

// ‚úÖ show info
document.getElementById("principalName").innerText =
"Welcome, " + (data.fullName || "Principal");

document.getElementById("principalEmail").innerText =
user.email;


// üìä LOAD STATS
loadStats();

}catch(err){
console.error(err);
window.location.href="index.html";
}

});



/* üìä COUNT USERS */
async function loadStats(){

const snapshot = await getDocs(collection(db,"users"));

let students=0;
let teachers=0;

snapshot.forEach(doc=>{
const role = doc.data().role;

if(role==="student") students++;
if(role==="teacher") teachers++;
});

document.getElementById("studentCount").innerText=students;
document.getElementById("teacherCount").innerText=teachers;

}



/* üö™ LOGOUT */
window.logout = async function(){

await signOut(auth);

window.location.href="index.html";

};

</script>

</body>
</html>n updateSecurity(){
    const newName=document.getElementById('editPrincipalName').value;
    let users=JSON.parse(localStorage.getItem('bis_users'))||[];
    let currentUser=JSON.parse(localStorage.getItem('currentUser'));
    const idx=users.findIndex(u=>u.username===currentUser.username);

    if(idx!==-1){
        users[idx].fullName=newName;
        currentUser.fullName=newName;
        localStorage.setItem('bis_users',JSON.stringify(users));
        localStorage.setItem('currentUser',JSON.stringify(currentUser));
        location.reload();
    }
}

function logout(){
    localStorage.removeItem('currentUser');
    window.location.href='index.html';
}

function openAnnouncementModal(){
    document.getElementById('announcementModal').style.display='flex';
}

function closeAnnouncementModal(){
    document.getElementById('announcementModal').style.display='none';
}
</script>

<script type="module">
/* --- FIREBASE ENGINE --- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { 
    getFirestore, 
    collection, 
    addDoc, 
    serverTimestamp,
    getDocs 
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBIQog_gsN6U-2JXwpv8CBSMLuP92W6a7Q",
  authDomain: "school-management-system-2f7de.firebaseapp.com",
  projectId: "school-management-system-2f7de",
  storageBucket: "school-management-system-2f7de.firebasestorage.app",
  messagingSenderId: "518987437886",
  appId: "1:518987437886:web:3d451457c4a6457e007e6f",
  measurementId: "G-KW2273D3C2"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* üìä DASHBOARD STATS: FETCHING FROM 'users' COLLECTION */
window.refreshStats = async function(){
    try {
        const snapshot = await getDocs(collection(db, "users")); 
        let students = 0;
        let teachers = 0;

        snapshot.forEach(doc => {
            const data = doc.data();
            // Check the role field in each user document
            if(data.role === "student") students++;
            else if(data.role === "teacher") teachers++;
        });

        document.getElementById("studentCount").innerText = students;
        document.getElementById("teacherCount").innerText = teachers;
        console.log("Stats loaded: ", {students, teachers});

    } catch(err) {
        console.error("Firebase Count Error:", err);
    }
};

/* üì£ POST ANNOUNCEMENT TO FIREBASE */
window.postAnnouncement = async function () {
    const text = document.getElementById('announcementText').value.trim();
    if (!text) {
        alert("Announcement cannot be empty.");
        return;
    }

    try {
        await addDoc(collection(db, "announcements"), {
            message: text,
            postedBy: "Principal",
            createdAt: serverTimestamp()
        });

        document.getElementById('announcementText').value = "";
        closeAnnouncementModal();
        alert("Announcement sent successfully! ‚úÖ");

    } catch (err) {
        alert("Failed to send announcement ‚ùå");
        console.error(err);
    }
};
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Assignments</title>

<style>
body{
    font-family: Segoe UI;
    background:#fcfaf5;
    padding:20px;
}

h2{ margin-bottom:15px; }

.card{
    background:white;
    padding:18px;
    border-radius:14px;
    margin-bottom:12px;
    box-shadow:0 4px 10px rgba(0,0,0,.06);
    cursor:pointer;
}

.card:hover{
    transform:scale(1.01);
}

.title{
    font-weight:bold;
    font-size:18px;
}

.meta{
    font-size:13px;
    color:gray;
    margin-top:6px;
}

.empty{
    text-align:center;
    margin-top:80px;
    color:gray;
    font-size:18px;
}

/* MODAL */
.modal{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,.6);
    display:none;
    align-items:center;
    justify-content:center;
    z-index:999;
}

.modal-content{
    background:white;
    width:100%;
    max-width:400px;
    border-radius:16px;
    padding:22px;
}

.modal h3{
    margin-bottom:10px;
}

.btn{
    width:100%;
    padding:12px;
    border:none;
    border-radius:10px;
    font-weight:bold;
    cursor:pointer;
    margin-top:10px;
}

.done-btn{
    background:#3E2723;
    color:#FFB300;
}

.close-btn{
    background:#eee;
}
</style>
</head>

<body>

<h2>My Assignments</h2>
<div id="list"></div>

<!-- MODAL -->
<div class="modal" id="modal">
    <div class="modal-content">
        <h3 id="mTitle"></h3>
        <p id="mDesc"></p>
        <div class="meta" id="mMeta"></div>

        <button class="btn done-btn" onclick="markDone()">âœ” Mark as Done</button>
        <button class="btn close-btn" onclick="closeModal()">Close</button>
    </div>
</div>


<!-- âœ… FIREBASE -->
<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";

import {
getFirestore,
collection,
getDocs,
query,
where,
addDoc
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";


// ðŸ”¥ YOUR CONFIG (already inserted)
const firebaseConfig = {
  apiKey: "AIzaSyBIQog_gsN6U-2JXwpv8CBSMLuP92W6a7Q",
  authDomain: "school-management-system-2f7de.firebaseapp.com",
  projectId: "school-management-system-2f7de",
  storageBucket: "school-management-system-2f7de.firebasestorage.app",
  messagingSenderId: "518987437886",
  appId: "1:518987437886:web:3d451457c4a6457e007e6f",
  measurementId: "G-KW2273D3C2"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);


// ðŸ” AUTH
const user = JSON.parse(localStorage.getItem("currentUser"));

if(!user){
    alert("Session expired");
    location.href="index.html";
}

const studentUsername = user.username;

const studentClass = (user.class || user.grade || "")
.replace(/\s/g,'')
.toUpperCase();


let activeAssignment = null;
let assignmentsCache = [];

loadAssignments();


// ðŸš€ LOAD FROM FIREBASE
async function loadAssignments(){

const list = document.getElementById("list");
list.innerHTML = "Loading assignments...";

try{

    // get assignments
    const snap = await getDocs(collection(db,"assignments"));

    const assignments = snap.docs.map(doc=>({
        id:doc.id,
        ...doc.data()
    }));


    // get DONE assignments for THIS student
    const doneQuery = query(
        collection(db,"assignment_done"),
        where("studentUsername","==",studentUsername)
    );

    const doneSnap = await getDocs(doneQuery);

    const doneIDs = doneSnap.docs.map(d=>d.data().assignmentId);


    // FILTER
    const myAssignments = assignments.filter(a=>{

        if(!a.grade) return false;

        const g = a.grade.replace(/\s/g,'').toUpperCase();

        return g === studentClass && !doneIDs.includes(a.id);
    });

    assignmentsCache = myAssignments;

    render(myAssignments);

}catch(err){
console.error(err);
list.innerHTML="Failed to load assignments.";
}

}



// ðŸŽ¨ RENDER
function render(data){

const list = document.getElementById("list");

if(data.length===0){
list.innerHTML = `<div class="empty">No assignments ðŸŽ‰</div>`;
return;
}

list.innerHTML = data.reverse().map(a=>`
<div class="card" onclick="openModal('${a.id}')">
    <div class="title">${a.title}</div>
    <div class="meta">${a.teacher || "Teacher"} â€¢ ${a.date || ""}</div>
</div>
`).join("");

}


// ðŸ“Œ MODAL
window.openModal = function(id){

activeAssignment = assignmentsCache.find(a=>a.id===id);

document.getElementById("mTitle").innerText = activeAssignment.title;
document.getElementById("mDesc").innerText = activeAssignment.description;

document.getElementById("mMeta").innerHTML = `
Teacher: ${activeAssignment.teacher || "Teacher"}<br>
Class: ${activeAssignment.grade}<br>
Date: ${activeAssignment.date || ""}
`;

document.getElementById("modal").style.display="flex";

}


window.closeModal = function(){
document.getElementById("modal").style.display="none";
activeAssignment=null;
}



// âœ… MARK DONE (PERMANENTLY HIDDEN)
window.markDone = async function(){

if(!activeAssignment) return;

try{

await addDoc(collection(db,"assignment_done"),{
assignmentId: activeAssignment.id,
studentUsername: studentUsername,
doneAt: Date.now()
});

closeModal();

loadAssignments(); // instant refresh

}catch(err){
console.error(err);
alert("Failed to mark as done.");
}

}

</script>

</body>
</html>
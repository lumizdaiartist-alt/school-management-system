<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Upload Results - BIS</title>

<link rel="stylesheet"
href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<style>
:root{
--chocolate:#3E2723;
--gold:#FFB300;
--cream:#FFF8E1;
}

*{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',sans-serif;}
body{background:#fcfaf5;padding-bottom:80px;}

.header{
background:var(--chocolate);
padding:20px;
color:white;
display:flex;
gap:15px;
align-items:center;
}

.setup-section{
background:white;
padding:15px;
border-bottom:2px solid var(--gold);
}

.row-inputs{
display:flex;
gap:10px;
margin-bottom:10px;
}

select{
flex:1;
padding:12px;
border-radius:8px;
border:1px solid #ddd;
font-weight:bold;
}

.table-container{
overflow:auto;
padding:10px;
}

table{
width:100%;
min-width:700px;
border-collapse:collapse;
background:white;
}

th,td{
border:1px solid #ddd;
padding:8px;
text-align:center;
}

.stu-name-cell{
text-align:left;
font-weight:bold;
}

input[type="number"]{
width:55px;
padding:6px;
font-weight:bold;
}

.footer-actions{
position:fixed;
bottom:0;
width:100%;
background:white;
padding:15px;
display:flex;
justify-content:space-between;
box-shadow:0 -2px 10px rgba(0,0,0,.1);
}

.save-btn{
background:var(--chocolate);
color:white;
border:none;
padding:15px 40px;
border-radius:10px;
font-weight:bold;
cursor:pointer;
}

.save-btn:disabled{
opacity:.6;
cursor:not-allowed;
}
</style>
</head>

<body>

<div class="header">
<a href="teacher_dash.html" style="color:white;">
<i class="fas fa-arrow-left"></i>
</a>
<h2>Upload Results</h2>
</div>

<div class="setup-section">

<div class="row-inputs">
<select id="termSelect">
<option>FIRST TERM</option>
<option>SECOND TERM</option>
<option>THIRD TERM</option>
</select>

<select id="yearSelect">
<option>2024/2025</option>
<option selected>2025/2026</option>
<option>2026/2027</option>
</select>
</div>

<div class="row-inputs">

<select id="classSelect">
<option value="">Select Class</option>
<option>JSS1</option>
<option>JSS2</option>
<option>JSS3</option>
<option>SSS1</option>
<option>SSS2</option>
<option>SSS3</option>
</select>

<select id="subjectSelect">
<option value="">Select Subject</option>
</select>

</div>
</div>

<div class="table-container">
<table>
<thead>
<tr>
<th>Student</th>
<th>CA1</th>
<th>CA2</th>
<th>CA3</th>
<th>Exam</th>
<th>Total</th>
<th>Grade</th>
</tr>
</thead>

<tbody id="studentRows">
<tr>
<td colspan="7" style="padding:40px;color:#999;">
Select a class
</td>
</tr>
</tbody>

</table>
</div>

<div class="footer-actions">
<div id="statusMsg">Waiting...</div>
<button id="uploadBtn" class="save-btn" onclick="saveAllResults()">
Upload Scores
</button>
</div>


<script type="module">

import { initializeApp }
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";

import {
getFirestore,
collection,
query,
where,
getDocs,
addDoc
}
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";


/* FIREBASE */
const firebaseConfig = {
apiKey: "AIzaSyBIQog_gsN6U-2JXwpv8CBSMLuP92W6a7Q",
authDomain: "school-management-system-2f7de.firebaseapp.com",
projectId: "school-management-system-2f7de",
storageBucket: "school-management-system-2f7de.appspot.com",
messagingSenderId: "518987437886",
appId: "1:518987437886:web:3d451457c4a6457e007e6f"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);


/* SUBJECT LISTS */

const jssSubjects = [
"Mathematics","English","Basic Science","Basic Technology",
"Computer Science","Hausa","Creative and Cultural Arts",
"Home Economics","Social Studies","Security","Civic Education"
];

const sssSubjects = [
"Mathematics","English","Physics","Chemistry","Biology",
"Literature","CRS/IRS","Further Mathematics","Geography",
"Economics","Marketing","Computer","Commerce",
"Accounting","Civic Education"
];

const classSelect = document.getElementById("classSelect");
const subjectSelect = document.getElementById("subjectSelect");
const studentRows = document.getElementById("studentRows");
const statusMsg = document.getElementById("statusMsg");
const uploadBtn = document.getElementById("uploadBtn");


/* LOAD STUDENTS */

classSelect.addEventListener("change", loadStudents);

async function loadStudents(){

const cls = classSelect.value;
if(!cls) return;

subjectSelect.innerHTML =
'<option value="">Select Subject</option>';

const list = cls.startsWith("JSS") ? jssSubjects : sssSubjects;

list.forEach(sub=>{
const opt=document.createElement("option");
opt.value=sub;
opt.innerText=sub;
subjectSelect.appendChild(opt);
});

studentRows.innerHTML =
`<tr><td colspan="7">Loading students...</td></tr>`;

const q = query(
collection(db,"users"),
where("role","==","student"),
where("class","==",cls)
);

const snap = await getDocs(q);

if(snap.empty){
studentRows.innerHTML =
`<tr><td colspan="7">No students found</td></tr>`;
return;
}

let rows="";

snap.forEach(doc=>{

const s = doc.data();

rows+=`
<tr data-id="${doc.id}">
<td class="stu-name-cell">${s.fullName}</td>

<td><input type="number" class="ca1" oninput="calc(this)"></td>
<td><input type="number" class="ca2" oninput="calc(this)"></td>
<td><input type="number" class="ca3" oninput="calc(this)"></td>
<td><input type="number" class="exam" oninput="calc(this)"></td>

<td class="total">0</td>
<td class="grade">-</td>
</tr>
`;
});

studentRows.innerHTML = rows;
}


/* CALCULATE */

window.calc = function(input){

const row=input.closest("tr");

const nums=["ca1","ca2","ca3","exam"]
.map(c=>parseFloat(row.querySelector("."+c).value)||0);

const total=nums.reduce((a,b)=>a+b,0);

row.querySelector(".total").innerText=total;

let grade="F9";

if(total>=75) grade="A1";
else if(total>=70) grade="B2";
else if(total>=65) grade="B3";
else if(total>=60) grade="C4";
else if(total>=55) grade="C5";
else if(total>=50) grade="C6";
else if(total>=45) grade="D7";
else if(total>=40) grade="E8";

row.querySelector(".grade").innerText=grade;
};


/* SAVE + REDIRECT */

window.saveAllResults = async function(){

const cls=classSelect.value;
const subj=subjectSelect.value;
const term=termSelect.value;
const year=yearSelect.value;

if(!cls || !subj){
alert("Select class and subject");
return;
}

uploadBtn.disabled=true;
statusMsg.innerText="Uploading...";

try{

const promises=[];

document.querySelectorAll("#studentRows tr")
.forEach(row=>{

const id=row.dataset.id;
if(!id) return;

promises.push(

addDoc(collection(db,"results"),{

studentId:id,
studentName:row.children[0].innerText,
class:cls,
subject:subj,
term,
year,

ca1:+row.querySelector(".ca1").value||0,
ca2:+row.querySelector(".ca2").value||0,
ca3:+row.querySelector(".ca3").value||0,
exam:+row.querySelector(".exam").value||0,

total:+row.querySelector(".total").innerText,
grade:row.querySelector(".grade").innerText,

createdAt:Date.now()

})

);

});

await Promise.all(promises);

statusMsg.innerText="âœ… Upload Complete! Redirecting...";

/* ðŸ”¥ GO TO VIEW RESULTS */
setTimeout(()=>{
window.location.href="New view_reports.html";
},1200);

}catch(err){

alert(err.message);
uploadBtn.disabled=false;
statusMsg.innerText="Upload failed";

}

};

</script>

</body>
</html>
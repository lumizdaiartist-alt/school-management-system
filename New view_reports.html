<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Academic Reports - BIS</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --chocolate: #3E2723;
            --gold: #FFB300;
            --cream: #FFF8E1;
            --white: #ffffff;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background-color: #fcfaf5; padding: 20px; }

        .header { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; color: var(--chocolate); }
        .back-btn { color: var(--chocolate); text-decoration: none; font-size: 20px; }
        .breadcrumb { margin-bottom: 15px; font-size: 13px; color: #666; font-weight: 500; }
        .breadcrumb span { cursor: pointer; color: var(--gold); }

        /* Folder Grid */
        .folder-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .folder {
            background: white; padding: 25px 15px; border-radius: 15px;
            display: flex; flex-direction: column; align-items: center;
            gap: 10px; cursor: pointer; border: 1px solid #eee;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05); transition: 0.2s;
        }
        .folder:active { transform: scale(0.95); }
        .folder i { font-size: 45px; color: var(--gold); }
        .folder span { color: var(--chocolate); font-weight: 700; font-size: 15px; }

        /* Student List */
        .student-list { display: none; background: white; border-radius: 15px; padding: 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .student-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 18px; border-bottom: 1px solid #eee; cursor: pointer;
        }
        .student-item:last-child { border-bottom: none; }
        .student-item span { color: var(--chocolate); font-weight: 600; }

        /* Modal / Report Card */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); display: none; justify-content: center; align-items: center;
            z-index: 3000; padding: 15px;
        }
        .report-card {
            background: white; width: 100%; max-width: 600px; border-radius: 20px;
            overflow: hidden; animation: slideUp 0.3s ease-out;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .report-header { background: var(--chocolate); padding: 20px; text-align: center; color: white; }
        .report-header h3 { color: var(--gold); font-size: 14px; margin-bottom: 5px; }
        
        .report-body { padding: 20px; }
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .info-item { font-size: 12px; color: #555; border-bottom: 1px solid #f0f0f0; padding-bottom: 5px; }
        .info-item b { color: var(--chocolate); }

        table.result-table { width: 100%; border-collapse: collapse; font-size: 12px; margin-top: 10px; }
        table.result-table th { background: #f8f8f8; color: var(--chocolate); border: 1px solid #ddd; padding: 8px; }
        table.result-table td { border: 1px solid #ddd; padding: 10px; text-align: center; }

        .print-footer { padding: 15px; display: flex; gap: 10px; }
        .btn { flex: 1; padding: 14px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; }
        .btn-print { background: var(--gold); color: var(--chocolate); }
        .btn-close { background: #eee; color: #333; }

        @keyframes slideUp { from { transform: translateY(40px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        @media print {
            body * { visibility: hidden; }
            .report-card, .report-card * { visibility: visible; }
            .report-card { position: fixed; left: 0; top: 0; width: 100%; box-shadow: none; border: none; }
            .print-footer { display: none; }
        }
    </style>
</head>
<body>

    <div class="header">
        <a href="principal_dash.html" class="back-btn"><i class="fas fa-arrow-left"></i></a>
        <h2>Reports Vault</h2>
    </div>

    <div id="breadcrumb" class="breadcrumb">
        <span onclick="showClasses()">All Classes</span> <span id="pathClass"></span>
    </div>

    <div id="folderArea" class="folder-grid"></div>

    <div id="studentListArea" class="student-list"></div>

    <div class="modal-overlay" id="resultModal">
        <div class="report-card">
            <div class="report-header">
                <h3>BENIAIAH INTERNATIONAL SCHOOL</h3>
                <h2 style="font-size: 16px;">STUDENT ACADEMIC RECORD</h2>
            </div>
            <div class="report-body">
                <div class="info-grid">
                    <div class="info-item">NAME: <b id="modalName">...</b></div>
                    <div class="info-item">CLASS: <b id="modalClass">...</b></div>
                    <div class="info-item">TERM: <b id="modalTerm">...</b></div>
                    <div class="info-item">YEAR: <b id="modalYear">...</b></div>
                </div>

                <table class="result-table">
                    <thead>
                        <tr>
                            <th style="text-align:left">SUBJECT</th>
                            <th>CA1</th>
                            <th>CA2</th>
                            <th>CA3</th>
                            <th>EXAM</th>
                            <th style="background:var(--cream)">TOTAL</th>
                        </tr>
                    </thead>
                    <tbody id="modalTableBody"></tbody>
                </table>
            </div>
            <div class="print-footer">
                <button class="btn btn-close" onclick="closeModal()">Close</button>
                <button id="btnPrint" class="btn btn-print" onclick="window.print()">Print Result</button>
            </div>
        </div>
    </div>

    <script>
        // Data Sources
        const results = JSON.parse(localStorage.getItem('bis_results')) || {};
        const users = JSON.parse(localStorage.getItem('bis_users')) || [];

        function showClasses() {
            document.getElementById('pathClass').innerText = "";
            document.getElementById('studentListArea').style.display = 'none';
            const folderArea = document.getElementById('folderArea');
            folderArea.style.display = 'grid';

            const classes = ["JSS1", "JSS2", "JSS3", "SS1", "SS2", "SS3"];
            folderArea.innerHTML = classes.map(c => `
                <div class="folder" onclick="showStudents('${c}')">
                    <i class="fas fa-folder"></i>
                    <span>${c}</span>
                </div>
            `).join('');
        }

        function showStudents(cls) {
            document.getElementById('folderArea').style.display = 'none';
            document.getElementById('pathClass').innerHTML = ` > <span>${cls}</span>`;
            const listArea = document.getElementById('studentListArea');
            listArea.style.display = 'block';

            const students = users.filter(u => u.role === 'student' && u.studentClass === cls);
            
            if(students.length === 0) {
                listArea.innerHTML = "<p style='padding:30px; text-align:center; color:#999;'>No students registered in this class.</p>";
                return;
            }

            listArea.innerHTML = students.map(s => `
                <div class="student-item" onclick="openReportModal('${s.username}', '${s.fullName}', '${cls}')">
                    <span><i class="fas fa-user-circle" style="margin-right:12px; color:var(--gold);"></i> ${s.fullName}</span>
                    <i class="fas fa-chevron-right" style="color:#ddd;"></i>
                </div>
            `).join('');
        }

        function openReportModal(studentId, fullName, cls) {
            document.getElementById('modalName').innerText = fullName.toUpperCase();
            document.getElementById('modalClass').innerText = cls;

            const settings = JSON.parse(localStorage.getItem('bis_settings')) || { term: 'N/A', year: 'N/A' };
            document.getElementById('modalTerm').innerText = settings.term;
            document.getElementById('modalYear').innerText = settings.year;

            const tbody = document.getElementById('modalTableBody');
            tbody.innerHTML = "";
            
            let foundAny = false;
            const classData = results[cls] || {};

            // CRITICAL FIX: Loop through all subjects to find this student's scores
            for (let subject in classData) {
                const score = classData[subject][studentId];
                if (score) {
                    foundAny = true;
                    tbody.innerHTML += `
                        <tr>
                            <td style="text-align:left; font-weight:600;">${subject}</td>
                            <td>${score.ca1 || 0}</td>
                            <td>${score.ca2 || 0}</td>
                            <td>${score.ca3 || 0}</td>
                            <td>${score.exam || 0}</td>
                            <td style="font-weight:bold; background:#fff8e1;">${score.total || 0}</td>
                        </tr>
                    `;
                }
            }

            if (!foundAny) {
                tbody.innerHTML = "<tr><td colspan='6' style='padding:30px; color:#999;'>No results uploaded for this student yet.</td></tr>";
            }

            document.getElementById('resultModal').style.display = 'flex';
        }

        function closeModal() { document.getElementById('resultModal').style.display = 'none'; }

        window.onload = showClasses;
    </script>
</body>
</html>

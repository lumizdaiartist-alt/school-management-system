<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fee Records - BIS</title>

<link rel="stylesheet"
href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<style>

:root{
--chocolate:#3E2723;
--gold:#FFB300;
--white:#ffffff;
--green:#2e7d32;
--red:#c62828;
}

*{
margin:0;
padding:0;
box-sizing:border-box;
font-family:'Segoe UI',sans-serif;
}

body{
background:#fcfaf5;
padding:15px;
}

.header{
display:flex;
gap:15px;
align-items:center;
margin-bottom:20px;
color:var(--chocolate);
}

.summary-grid{
display:grid;
grid-template-columns:1fr 1fr;
gap:10px;
margin-bottom:20px;
}

.sum-card{
background:white;
padding:15px;
border-radius:12px;
text-align:center;
box-shadow:0 2px 5px rgba(0,0,0,.05);
}

.search-box{
width:100%;
padding:12px;
border-radius:10px;
border:1px solid #ddd;
margin-bottom:15px;
}

/* cards */

.fee-card{
background:white;
padding:15px;
border-radius:12px;
margin-bottom:10px;
display:flex;
justify-content:space-between;
border-left:5px solid var(--gold);
}

.status{
font-size:10px;
font-weight:bold;
padding:3px 7px;
border-radius:4px;
margin-top:5px;
display:inline-block;
}

.paid{
background:#e8f5e9;
color:var(--green);
}

.debt{
background:#ffebee;
color:var(--red);
}

</style>
</head>

<body>

<div class="header">
<h2>Fee Records</h2>
</div>

<div class="summary-grid">

<div class="sum-card" style="grid-column:span 2;">
<p>Total Revenue</p>
<h3 id="totalRevenue">â‚¦0</h3>
</div>

<div class="sum-card">
<h3 id="paidCount">0</h3>
<p>Fully Paid</p>
</div>

<div class="sum-card">
<h3 id="debtCount">0</h3>
<p>Owing</p>
</div>

</div>

<input
type="text"
id="feeSearch"
class="search-box"
placeholder="Search student..."
onkeyup="filterFees()">

<div id="feeList"></div>



<script type="module">

import { initializeApp }
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";

import {
getFirestore,
collection,
query,
where,
getDocs
}
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";


const firebaseConfig={
apiKey:"AIzaSyBIQog_gsN6U-2JXwpv8CBSMLuP92W6a7Q",
authDomain:"school-management-system-2f7de.firebaseapp.com",
projectId:"school-management-system-2f7de",
storageBucket:"school-management-system-2f7de.appspot.com",
messagingSenderId:"518987437886",
appId:"1:518987437886:web:3d451457c4a6457e007e6f"
};

const app=initializeApp(firebaseConfig);
const db=getFirestore(app);


/* ðŸ”¥ GET CURRENT TERM */

const currentTerm=
localStorage.getItem("currentTerm") || "FIRST TERM";

const currentYear=
localStorage.getItem("currentYear") || "2025/2026";



async function loadFees(){

const list=document.getElementById("feeList");

const studentsSnap=await getDocs(
query(collection(db,"users"),
where("role","==","student"))
);

const feesSnap=await getDocs(
query(collection(db,"fees"),
where("term","==",currentTerm),
where("year","==",currentYear))
);


/* convert fees into map for FAST lookup */

const feeMap={};

feesSnap.forEach(doc=>{

const f=doc.data();
feeMap[f.studentId]=f;

});


let revenue=0;
let paid=0;
let debt=0;

let html="";


studentsSnap.forEach(doc=>{

const s=doc.data();
const studentId=doc.id;

const studentClass=
s.studentClass || s.class || "JSS1";


const totalExpected=
studentClass.startsWith("SS")
?82000:77000;


/* if no fee doc -> amount is zero */
const fee=feeMap[studentId];

const amountPaid=
fee?.amountPaid || 0;

const balance=
totalExpected-amountPaid;

revenue+=amountPaid;

if(balance<=0)
paid++;
else
debt++;


html+=`

<div class="fee-card">

<div>

<h4>${s.fullName}</h4>

<p style="font-size:12px;color:#666;">
${studentClass}
</p>

<span class="status ${balance<=0?'paid':'debt'}">

${balance<=0
?'Fully Paid'
:`Owes â‚¦${balance.toLocaleString()}`}

</span>

</div>

<div style="text-align:right;">

<p style="font-size:11px;color:#888;">
Paid
</p>

<h4>
â‚¦${amountPaid.toLocaleString()}
</h4>

</div>

</div>

`;

});


list.innerHTML=html;

document.getElementById("totalRevenue")
.innerText="â‚¦"+revenue.toLocaleString();

document.getElementById("paidCount")
.innerText=paid;

document.getElementById("debtCount")
.innerText=debt;

}



/* SEARCH */

window.filterFees=function(){

const q=
document.getElementById("feeSearch")
.value.toLowerCase();

document
.querySelectorAll(".fee-card")
.forEach(card=>{

const name=
card.querySelector("h4")
.innerText.toLowerCase();

card.style.display=
name.includes(q)
?"flex":"none";

});

};


loadFees();

</script>

</body>
</html>
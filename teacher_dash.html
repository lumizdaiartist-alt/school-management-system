<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Portal - British International School</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --chocolate: #3E2723;
            --chocolate-light: #5D4037;
            --gold: #FFB300;
            --bg: #F8F5F2;
            --white: #ffffff;
            --text-main: #2C1E1B;
            --text-muted: #757575;
            --border: #E0D7D5;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', 'Segoe UI', sans-serif; }
        body { background: var(--bg); color: var(--text-main); line-height: 1.6; }

        .navbar {
            background: var(--chocolate);
            padding: 1rem 5%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: var(--white);
            position: sticky; top: 0; z-index: 1000;
        }

        .nav-brand { font-weight: 700; letter-spacing: 1px; font-size: 1.1rem; }
        .nav-profile { display: flex; align-items: center; gap: 12px; }
        .avatar {
            width: 38px; height: 38px; background: var(--gold); color: var(--chocolate);
            border-radius: 8px; display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 14px;
        }

        .dashboard-header {
            background: var(--white);
            border-bottom: 1px solid var(--border);
            padding: 2rem 5% 4rem;
        }

        .welcome-msg h1 { font-size: 1.75rem; color: var(--chocolate); margin-bottom: 4px; }
        .welcome-msg p { color: var(--text-muted); font-size: 0.9rem; }

        .container { max-width: 1200px; margin: -3rem auto 0; padding: 0 5% 5rem; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card {
            background: var(--white); padding: 1.5rem; border-radius: 12px;
            border: 1px solid var(--border); display: flex; align-items: center; gap: 20px;
        }
        .stat-icon {
            width: 50px; height: 50px; background: #FFF8E1; color: var(--gold);
            border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem;
        }
        .stat-info h3 { font-size: 1.5rem; color: var(--chocolate); }
        .stat-info span { font-size: 0.8rem; color: var(--text-muted); text-transform: uppercase; font-weight: 600; }

        .action-bar {
            background: var(--white); padding: 15px; border-radius: 12px;
            border: 1px solid var(--border); margin-bottom: 30px;
            display: flex; flex-wrap: wrap; gap: 15px; align-items: center;
        }
        .btn {
            padding: 10px 20px; border-radius: 8px; border: 1px solid var(--border);
            background: var(--white); color: var(--chocolate); cursor: pointer;
            font-weight: 600; font-size: 0.9rem; transition: 0.2s; display: inline-flex; align-items: center; gap: 8px;
        }
        .btn:hover { background: #fdfcfb; border-color: var(--chocolate); }
        .btn-primary { background: var(--chocolate); color: white; border: none; }
        .btn-primary:hover { background: var(--chocolate-light); }

        .search-wrapper { flex-grow: 1; position: relative; }
        .search-wrapper input { width: 100%; padding: 10px 15px 10px 40px; border-radius: 8px; border: 1px solid var(--border); outline: none; }
        .search-wrapper i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--text-muted); }

        .content-section { background: var(--white); border-radius: 12px; border: 1px solid var(--border); overflow: hidden; }
        .section-header { padding: 20px 25px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .assignment-item { padding: 20px 25px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; transition: background 0.2s; }
        .assignment-item:hover { background: #fafafa; }
        .assign-info h4 { color: var(--chocolate); margin-bottom: 5px; }
        .assign-meta { display: flex; gap: 15px; font-size: 0.85rem; color: var(--text-muted); }
        .assign-meta span { display: flex; align-items: center; gap: 5px; }
        .assign-actions { display: flex; gap: 10px; }
        .btn-icon { width: 35px; height: 35px; border-radius: 6px; border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; }
        .btn-edit:hover { background: #e3f2fd; color: #1976d2; }
        .btn-delete:hover { background: #ffebee; color: #c62828; }

        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(44, 30, 27, 0.8); display: none; justify-content: center; align-items: center; z-index: 2000;
        }
        .modal-box { background: var(--white); width: 90%; max-width: 500px; padding: 30px; border-radius: 16px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-size: 0.85rem; font-weight: 600; margin-bottom: 5px; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; }
        .logout-container { text-align: center; margin-top: 40px; }
        .btn-logout { color: #c62828; text-decoration: none; font-weight: 600; font-size: 0.9rem; cursor: pointer; }
    </style>
</head>

<body>

<nav class="navbar">
    <div class="nav-brand">BIS TEACHER PORTAL</div>
    <div class="nav-profile">
        <span id="teacherID_nav" style="font-size: 0.8rem; opacity: 0.8;"></span>
        <div class="avatar" id="avatar"></div>
    </div>
</nav>

<header class="dashboard-header">
    <div class="welcome-msg" style="max-width: 1200px; margin: 0 auto; padding: 0 5%;">
        <h1 id="teacherName">Loading Portal...</h1>
        <p>Manage your classroom, track student progress, and organize assignments.</p>
    </div>
</header>

<div class="container">
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon"><i class="fas fa-file-alt"></i></div>
            <div class="stat-info">
                <h3 id="assignmentCount">0</h3>
                <span>Assignments</span>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon"><i class="fas fa-user-graduate"></i></div>
            <div class="stat-info">
                <h3 id="studentCount">0</h3>
                <span>Total Students</span>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon"><i class="fas fa-calendar-check"></i></div>
            <div class="stat-info">
                <h3 id="today"></h3>
                <span>Academic Date</span>
            </div>
        </div>
    </div>

    <div class="action-bar">
        <button class="btn btn-primary" onclick="toggleModal(true)">
            <i class="fas fa-plus"></i> Post Assignment
        </button>
        <button class="btn" onclick="location.href='my_students.html'">
            <i class="fas fa-users"></i> Students List
        </button>
        <button class="btn" onclick="location.href='upload_results.html'">
            <i class="fas fa-chart-line"></i> Grade Results
        </button>
        <div class="search-wrapper">
            <i class="fas fa-search"></i>
            <input id="searchInput" placeholder="Filter assignments..." onkeyup="filterLocalAssignments()">
        </div>
    </div>

    <div class="content-section">
        <div class="section-header">
            <h2 style="font-size: 1.1rem; color: var(--chocolate);">Active Assignments</h2>
            <i class="fas fa-history" style="color: var(--text-muted);"></i>
        </div>
        <div id="recentList">
            <p style="padding: 20px; text-align: center; color: #888;">Fetching assignments...</p>
        </div>
    </div>

    <div class="logout-container">
        <span class="btn-logout" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Sign out of Portal</span>
    </div>
</div>

<div class="modal" id="assignmentModal">
    <div class="modal-box">
        <h3 id="modalTitle">Create New Assignment</h3>
        <input type="hidden" id="editDocId">
        
        <div class="form-group">
            <label>Title</label>
            <input id="title" placeholder="e.g., Intro to Quadratic Equations">
        </div>

        <div class="form-group">
            <label>Target Grade</label>
            <select id="grade">
                <option>JSS 1</option><option>JSS 2</option><option value="JSS 3">JSS 3</option>
                <option>SSS 1</option><option>SSS 2</option><option value="SSS 3">SSS 3</option>
            </select>
        </div>

        <div class="form-group">
            <label>Instructions / Description</label>
            <textarea id="desc" rows="4" placeholder="Describe the task..."></textarea>
        </div>

        <button id="saveBtn" class="btn btn-primary" style="width: 100%; padding: 14px;" onclick="saveAssignment()">PUBLISH ASSIGNMENT</button>
        <button class="btn" style="width: 100%; margin-top: 10px; border: none;" onclick="toggleModal(false)">Discard</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { 
        getFirestore, collection, addDoc, getDocs, query, where, doc, deleteDoc, updateDoc, serverTimestamp 
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBIQog_gsN6U-2JXwpv8CBSMLuP92W6a7Q",
        authDomain: "school-management-system-2f7de.firebaseapp.com",
        projectId: "school-management-system-2f7de",
        storageBucket: "school-management-system-2f7de.firebasestorage.app",
        messagingSenderId: "518987437886",
        appId: "1:518987437886:web:3d451457c4a6457e007e6f",
        measurementId: "G-KW2273D3C2"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let ALL_ASSIGNMENTS = [];
    const currentUser = JSON.parse(localStorage.getItem('currentUser'));

    window.onload = async () => {
        if(!currentUser || currentUser.role !== 'teacher'){
            location.href="index.html";
            return;
        }

        document.getElementById("teacherName").innerText = "Welcome, " + currentUser.fullName;
        document.getElementById("teacherID_nav").innerText = currentUser.username;
        document.getElementById("today").innerText = new Date().toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });

        const names = currentUser.fullName.split(" ");
        document.getElementById("avatar").innerText = (names[0][0] + (names[1]?.[0] || "")).toUpperCase();

        await fetchStats();
        await fetchAssignments();
    };

    async function fetchStats() {
        try {
            const q = query(collection(db, "users"), where("role", "==", "student"));
            const snapshot = await getDocs(q);
            document.getElementById("studentCount").innerText = snapshot.size;
        } catch (e) { console.error(e); }
    }

    async function fetchAssignments() {
        const listDiv = document.getElementById("recentList");
        try {
            // WE REMOVED orderBy() FROM THE QUERY TO PREVENT INDEX ERRORS
            const q = query(
                collection(db, "assignments"), 
                where("teacherId", "==", currentUser.username)
            );
            const snapshot = await getDocs(q);
            
            // MAP DATA AND THEN SORT MANUALLY IN JAVASCRIPT
            ALL_ASSIGNMENTS = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            
            // SORT BY DATE DESCENDING
            ALL_ASSIGNMENTS.sort((a, b) => {
                const dateA = a.createdAt?.seconds || 0;
                const dateB = b.createdAt?.seconds || 0;
                return dateB - dateA;
            });
            
            document.getElementById("assignmentCount").innerText = ALL_ASSIGNMENTS.length;
            renderAssignments(ALL_ASSIGNMENTS);
        } catch (e) { 
            console.error("Fetch error: ", e);
            listDiv.innerHTML = "<p style='padding:20px; color:red;'>Failed to load assignments.</p>";
        }
    }

    function renderAssignments(list) {
        const container = document.getElementById("recentList");
        if(list.length === 0){
            container.innerHTML = "<div style='padding: 40px; text-align: center; color: #aaa;'>No active assignments. Click 'Post Assignment' to begin.</div>";
            return;
        }
        container.innerHTML = list.map(a => `
            <div class="assignment-item">
                <div class="assign-info">
                    <h4>${a.title}</h4>
                    <div class="assign-meta">
                        <span><i class="fas fa-graduation-cap"></i> ${a.grade}</span>
                        <span><i class="far fa-calendar-alt"></i> ${a.dateString || 'Just now'}</span>
                    </div>
                </div>
                <div class="assign-actions">
                    <div class="btn-icon btn-edit" onclick="window.prepareEdit('${a.id}')"><i class="fas fa-pen"></i></div>
                    <div class="btn-icon btn-delete" onclick="window.deleteAssignment('${a.id}')"><i class="fas fa-trash"></i></div>
                </div>
            </div>
        `).join("");
    }

    window.saveAssignment = async () => {
        const title = document.getElementById("title").value.trim();
        const grade = document.getElementById("grade").value;
        const desc = document.getElementById("desc").value.trim();
        const editId = document.getElementById("editDocId").value;

        if(!title || !desc) return alert("Fill all fields");

        const btn = document.getElementById("saveBtn");
        btn.innerText = "Processing...";
        btn.disabled = true;

        const data = {
            title, grade, description: desc,
            teacherName: currentUser.fullName,
            teacherId: currentUser.username,
            dateString: new Date().toLocaleDateString('en-GB'),
            createdAt: serverTimestamp()
        };

        try {
            if(editId) {
                await updateDoc(doc(db, "assignments", editId), data);
            } else {
                await addDoc(collection(db, "assignments"), data);
            }
            toggleModal(false);
            await fetchAssignments();
        } catch (e) { alert("Error saving: " + e.message); }
        btn.innerText = "PUBLISH ASSIGNMENT";
        btn.disabled = false;
    };

    window.deleteAssignment = async (id) => {
        if(!confirm("Delete this assignment?")) return;
        try {
            await deleteDoc(doc(db, "assignments", id));
            await fetchAssignments();
        } catch (e) { alert("Delete failed"); }
    };

    window.prepareEdit = (id) => {
        const a = ALL_ASSIGNMENTS.find(x => x.id === id);
        document.getElementById("modalTitle").innerText = "Edit Assignment";
        document.getElementById("editDocId").value = id;
        document.getElementById("title").value = a.title;
        document.getElementById("grade").value = a.grade;
        document.getElementById("desc").value = a.description;
        document.getElementById("saveBtn").innerText = "UPDATE ASSIGNMENT";
        toggleModal(true);
    };

    window.filterLocalAssignments = () => {
        const text = document.getElementById("searchInput").value.toLowerCase();
        const filtered = ALL_ASSIGNMENTS.filter(a => a.title.toLowerCase().includes(text));
        renderAssignments(filtered);
    };

    window.toggleModal = (show) => {
        if(!show) {
            document.getElementById("editDocId").value = "";
            document.getElementById("title").value = "";
            document.getElementById("desc").value = "";
            document.getElementById("modalTitle").innerText = "Create New Assignment";
            document.getElementById("saveBtn").innerText = "PUBLISH ASSIGNMENT";
        }
        document.getElementById("assignmentModal").style.display = show ? "flex" : "none";
    };

    window.logout = () => {
        if(confirm("Confirm Logout?")){
            localStorage.removeItem('currentUser');
            location.href="index.html";
        }
    };
</script>
</body>
</html>
